{{ if $.Values.auto_onboarding }}

{{- $onboardingSecret := (lookup "v1" "Secret" .Release.Namespace "onboarding-env") }}
---
kind: Secret
apiVersion: v1
metadata:
  name: onboarding-env
  annotations:
    "helm.sh/resource-policy": keep
data:
  {{ if $.Values.ONBOARDING_USER_NAME }}
  USER_NAME: {{ $.Values.ONBOARDING_USER_NAME | b64enc | quote }}
  {{ else if $onboardingSecret}}
  USER_NAME: {{ index $onboardingSecret.data "USER_NAME"  }} 
  {{ else }}
  USER_NAME: {{ "admin" | b64enc | quote }}
  {{ end }}
  {{ if $.Values.ONBOARDING_PASSWORD }}
  USER_PASSWORD: {{ $.Values.ONBOARDING_PASSWORD | b64enc | quote }}
  {{ else if $onboardingSecret}}
  USER_PASSWORD: {{ index $onboardingSecret.data "USER_PASSWORD" }}
  {{ else }}
  USER_PASSWORD: {{ (randAlphaNum 24) | nospace | b64enc | quote }}
  {{ end }}
  {{ if $.Values.ONBOARDING_EMAIL }}
  USER_EMAIL: {{ $.Values.ONBOARDING_EMAIL | b64enc | quote }}
  {{ else if $onboardingSecret}}
  USER_EMAIL: {{ index $onboardingSecret.data "USER_EMAIL" }}
  {{ else }}
  USER_EMAIL: {{ "admin@admin" | b64enc | quote }}
  {{ end }}
  {{ if $.Values.ONBOARDING_FULL_NAME }}
  USER_FULL_NAME: {{ $.Values.ONBOARDING_FULL_NAME | b64enc | quote }}
  {{ else if $onboardingSecret }}
  USER_FULL_NAME: {{ index $onboardingSecret.data "USER_FULL_NAME" }}
  {{ else }}
  USER_FULL_NAME: {{ "admin" | b64enc | quote }}
  {{ end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: mdss-import-config
data:
  {{ if $.Values.mdss_import_config }}
  mdss-config.json: |
    {{ .Values.mdss_import_config | b64enc }}
  {{ else }}
  mdss-config.json: |
    {{ "" | b64enc }}
  {{ end }}

{{ end }}


{{- if .Values.mdss_generate_secrets}}

# Generate, set or keep the postgres database credentials
{{- $postgresPasswordValue := (randAlphaNum 24) | nospace }}
{{- $postgresUserValue := "mdss" }}
{{- $postgresSecret := (lookup "v1" "Secret" .Release.Namespace "mdss-postgres-cred") }}

{{- if $postgresSecret }}
{{- if index $postgresSecret.data "POSTGRES_PASSWORD" }}
{{- $postgresPasswordValue = index $postgresSecret.data "POSTGRES_PASSWORD" | b64dec }}
{{- end }}
{{- if index $postgresSecret.data "POSTGRES_USER" }}
{{- $postgresUserValue = index $postgresSecret.data "POSTGRES_USER" | b64dec }}
{{- end }}
{{- end -}}

{{- if .Values.MDSS_DB_PASSWORD }}
{{- $postgresPasswordValue = .Values.MDSS_DB_PASSWORD }}
{{- end -}}

{{- if .Values.MDSS_DB_USER }}
{{- $postgresUserValue = .Values.MDSS_DB_USER }}
{{- end }}

---
kind: Secret
apiVersion: v1
metadata:
  name: {{ .Values.mdss_secret_env_name | default "mdss-postgres-cred" }}
  annotations:
    "helm.sh/resource-policy": keep
data:
  POSTGRES_USER: {{ $postgresUserValue | b64enc }}
  POSTGRES_PASSWORD: {{ $postgresPasswordValue | b64enc }}
  POSTGRES_DB: {{ .Values.MDSS_DB_NAME | default "MDSS" | b64enc }}
  POSTGRESQL_URL: {{ (.Values.POSTGRESQL_URL | replace "<MDSS_DB_HOST>" (.Values.MDSS_DB_HOST | default "postgres-mdss") | replace "<MDSS_DB_PORT>" (.Values.MDSS_DB_PORT | default "5432") | replace "<MDSS_DB_USER>" ($postgresUserValue) | replace "<MDSS_DB_PASSWORD>" ($postgresPasswordValue) | replace "<MDSS_DB_NAME>" (.Values.MDSS_DB_NAME | default "MDSS")) | b64enc }}

{{ end }}